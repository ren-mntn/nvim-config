# Git PR Worktree機能 要件定義書

## 🎯 機能概要

**PR（プルリクエスト）のブランチを自動取得してworktreeとして切り替える機能**

### 基本フロー
1. **PR一覧表示** → リモートのPR情報を取得・表示
2. **PR選択** → レビューしたいPRを選択
3. **ブランチ取得** → 該当ブランチをローカルに取得
4. **Worktree作成** → 自動的にworktreeを作成
5. **環境切り替え** → 新しいworktreeに移動

## 📋 詳細要件

### 🔍 **PR情報取得**

#### 必要な情報
- [x] **PR番号**: #123
- [x] **タイトル**: "Add new feature for user authentication"
- [x] **作成者**: username
- [x] **ブランチ名**: feature/auth-system
- [x] **ステータス**: open/draft/ready
- [x] **更新日時**: 最終更新タイムスタンプ

#### 取得方法の選択肢
- [ ] **GitHub CLI (`gh`)**: `gh pr list` コマンド使用（推奨）
- [ ] **Git remote**: `git ls-remote origin` でブランチ情報取得
- [ ] **GitHub API**: REST API直接呼び出し

#### フィルタリング条件
- [ ] **ステータス**: open PRのみ表示
- [ ] **作成者**: 特定のユーザーのPRのみ
- [ ] **ラベル**: 特定ラベル付きPRのみ
- [ ] **更新日順**: 最近更新されたPRから表示

### 🌿 **Worktree作成プロセス**

#### 自動処理フロー
- [ ] 1. **ブランチ存在チェック**: ローカルに既存ブランチがあるか確認
- [ ] 2. **リモートフェッチ**: `git fetch origin pull/123/head:pr-123`
- [ ] 3. **Worktree作成**: 既存の作成機能を流用
- [ ] 4. **環境セットアップ**: .vscode, .cursor, .npmrc等のコピー
- [ ] 5. **iTerm2起動**: 新しいタブでworktreeを開く

#### ブランチ命名規則
```
# パターン1: PR番号ベース
pr-123-auth-system

# パターン2: 元ブランチ名ベース  
feature-auth-system

# パターン3: 混合
pr-123-feature-auth-system
```

#### 重複処理
- [ ] **既存Worktreeチェック**: 同じPRのworktreeが既にあるか確認
- [ ] **更新処理**: 既存の場合は更新するかスキップするか選択
- [ ] **ブランチ同期**: リモートの最新状態にアップデート

### 🎨 **UI/UX設計**

#### Telescope統合
```
🔍 GitHub Pull Requests                    

➤ #123  Add user authentication           john-doe    2024-01-15
  #122  Fix responsive layout bug         jane-smith  2024-01-14  
  #121  Update dependencies               bob-wilson  2024-01-13
  #120  Add dark mode toggle              alice-chen  2024-01-12
```

#### 表示フォーマット
- **PR番号**: `#123`
- **タイトル**: 最大50文字で切り詰め
- **作成者**: GitHubユーザー名
- **更新日**: 相対時間表示（"2 days ago"）
- **ステータス**: アイコンで表示（🔓 open, 📝 draft）

#### キーバインド
- **Enter**: 選択したPRのworktreeを作成・切り替え
- **Ctrl+R**: PR一覧を更新
- **Ctrl+F**: フィルタリングオプション表示
- **Esc**: キャンセル

### ⚡ **パフォーマンス要件**

#### 応答速度
- [ ] **PR一覧取得**: 5秒以内
- [ ] **ブランチフェッチ**: 10秒以内
- [ ] **Worktree作成**: 15秒以内（既存機能と同等）

#### キャッシュ戦略
- [ ] **PR情報キャッシュ**: 5分間有効
- [ ] **手動更新**: `Ctrl+R`で強制更新
- [ ] **バックグラウンド更新**: 定期的な自動更新（オプション）

### 🔧 **技術仕様**

#### 依存関係
- [ ] **GitHub CLI (`gh`)**: PR情報取得（必須）
- [ ] **Git**: ブランチフェッチ・worktree操作
- [ ] **Telescope**: UI表示
- [ ] **既存worktree機能**: 作成・管理ロジック流用

#### エラーハンドリング
- [ ] **GitHub認証エラー**: `gh auth login`案内
- [ ] **ネットワークエラー**: オフライン時の適切な表示
- [ ] **権限エラー**: プライベートリポジトリアクセス失敗
- [ ] **Git操作エラー**: fetch失敗時の代替手段

#### 設定可能項目
```lua
local PR_CONFIG = {
  max_prs = 20,           -- 表示するPR数上限
  cache_duration = 300,   -- キャッシュ有効期間（秒）
  auto_fetch = true,      -- 自動フェッチ有効/無効
  branch_prefix = "pr-",  -- ブランチ名プレフィックス
  filters = {
    author = "",          -- 特定作成者のみ表示
    labels = {},          -- 特定ラベルのみ表示
    state = "open",       -- PR状態フィルタ
  }
}
```

### 🚫 **制約事項・前提条件**

#### 前提条件
- [ ] **GitHub CLI インストール済み**: `gh --version`で確認
- [ ] **GitHub認証済み**: `gh auth status`で確認
- [ ] **GitHubリポジトリ**: GitHubにホストされたプロジェクト
- [ ] **インターネット接続**: PR情報取得時に必要

#### 制約事項
- [ ] **GitHub専用**: GitLab, Bitbucket等は対象外
- [ ] **パブリックリポジトリ優先**: プライベートは認証次第
- [ ] **英語UI**: 日本語化は後回し（GitHubの言語設定に依存）

## ✅ 実装フェーズ

### Phase 1: 基本機能（MVP）
- [ ] 1. GitHub CLI連携でPR一覧取得
- [ ] 2. Telescope UIでPR表示・選択
- [ ] 3. 選択PRのブランチをフェッチ
- [ ] 4. 既存worktree機能でworktree作成
- [ ] 5. 基本的なエラーハンドリング

### Phase 2: UX改善
- [ ] 6. PR情報の詳細表示（作成者、更新日等）
- [ ] 7. キャッシュ機能実装
- [ ] 8. フィルタリングオプション
- [ ] 9. 重複チェック・更新機能
- [ ] 10. 設定のカスタマイズ対応

### Phase 3: 高度な機能
- [ ] 11. バックグラウンド更新
- [ ] 12. PR詳細プレビュー
- [ ] 13. コメント数・レビュー状況表示
- [ ] 14. 複数リポジトリ対応
- [ ] 15. パフォーマンス最適化

## 🔗 **関連機能との統合**

### 既存機能との連携
- [x] **Worktree作成**: 既存の`create_worktree()`ロジックを流用
- [x] **Worktree一覧**: PR由来のworktreeも一覧に表示
- [x] **Worktree削除**: 通常のworktreeと同様に削除可能
- [x] **環境セットアップ**: 既存のセットアップスクリプトを流用

### 新しいキーバインド
- [ ] `<leader>gp` - PR一覧表示・worktree作成
- [ ] `<leader>gP` - PR更新・同期

## 📊 **成功指標**

### 機能的指標
- [ ] **PR取得成功率**: 95%以上
- [ ] **Worktree作成成功率**: 95%以上
- [ ] **応答時間**: 上記要件内での完了

### ユーザビリティ指標
- [ ] **操作ステップ数**: 3ステップ以内でPRレビュー環境構築
- [ ] **学習コスト**: 既存worktree機能を使えれば即座に理解可能
- [ ] **エラー回復**: エラー時も明確なガイダンス提供

## 🚀 **次のステップ**

1. **GitHub CLI動作確認**: 現在の環境で`gh pr list`が動作するか確認
2. **実装方針決定**: MVP機能の詳細設計
3. **プロトタイプ作成**: 基本的なPR取得とworktree作成の連携
4. **テスト・改善**: 実際のPRで動作検証

---

**この要件定義書は実装進捗に応じて更新していきます。**