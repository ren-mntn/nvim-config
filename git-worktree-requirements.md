# Git Worktree管理機能 完全実装要件書

## 🎯 実装完了機能

### 🌿 **Worktree作成機能** (`<leader>gW`) - ✅ 完成
**フロー**: `<leader>gW` → 自動インサートモード → ブランチ名入力 → Enter → 自動ノーマルモード → 新しいiTerm2タブでworktree開始

### 🗑️ **Worktree削除機能** (`<leader>gw` → `Ctrl+D`) - ✅ 完成  
**フロー**: worktreeリスト表示 → Ctrl+D → 自動インサートモード → `y`/`N` 確認 → Enter → 自動ノーマルモード → バックグラウンド削除

### 🔄 **Worktree切り替え機能** (`<leader>gw`) - ✅ 完成
**フロー**: worktreeリスト表示 → 選択 → ディレクトリ切り替え → Neo-tree自動更新

## 📋 詳細要件（これまでの議論を反映）

## 🌿 **Worktree作成機能** 詳細仕様

### 基本操作フロー
- [x] 1. **トリガー**: `<leader>gW` を押す
- [x] 2. **入力UI**: 自動インサートモード → ブランチ名入力 → Enter → 自動ノーマルモード
- [x] 3. **Git操作**: `git worktree add -b [ブランチ名] git-worktrees/[ディレクトリ名] origin/main`
- [x] 4. **環境セットアップ**: `.vscode`, `.cursor`, `.npmrc` コピー（pnpm installは削除済み）
- [x] 5. **iTerm2起動**: 新しいタブで正しいworktreeディレクトリで開始

### 高度な機能
- [x] **ディレクトリ構造**: `git-worktrees/` ディレクトリに配置
- [x] **ブランチ名変換**: `feature/login` → `feature-login` ディレクトリ名  
- [x] **高速化**: pnpm install無効化により10秒以内完了
- [x] **iTerm2連携**: 新しいタブで自動的にworktreeディレクトリを開く
- [x] **自動モード切り替え**: 入力時インサートモード、完了時ノーマルモード

## 🗑️ **Worktree削除機能** 詳細仕様

### 基本操作フロー
- [x] 1. **リスト表示**: `<leader>gw` でworktree一覧をTelescope表示
- [x] 2. **削除トリガー**: `Ctrl+D` で削除確認
- [x] 3. **確認UI**: 自動インサートモード → `y`/`N` 入力 → Enter → 自動ノーマルモード  
- [x] 4. **バックグラウンド削除**: `vim.system`による非同期処理
- [x] 5. **完了通知**: 削除完了または修復完了メッセージ

### 高度な削除機能
- [x] **強制削除**: 常に`--force`オプションで削除
- [x] **修復機能**: 壊れたworktreeも自動検出・修復削除
- [x] **3段階削除**: worktree prune → force remove → ディレクトリ削除
- [x] **安全性**: main/masterブランチは削除不可
- [x] **UIノンブロッキング**: `vim.system`による非同期削除でNeovim操作可能
- [x] **自動モード切り替え**: 確認時インサートモード、処理後ノーマルモード

### 🛠️ 技術的詳細

#### A. ブランチ名処理
- [x] **入力**: 任意のブランチ名（`test/test/test`, `feature/awesome-idea`など）
- [x] **ディレクトリ名変換**: スラッシュ(`/`)をハイフン(`-`)に置換
  - [x] 例: `test/test/test` → `test-test-test`
  - [x] 例: `feature/new-login` → `feature-new-login`
- [x] **Git参照エラー回避**: ブランチ階層の衝突を防ぐ

#### B. ディレクトリ構造
```
プロジェクトルート/
├── .worktrees/
│   ├── feature-new-login/     # ← worktreeディレクトリ
│   ├── hotfix-critical-bug/
│   └── test-test-test/
├── .vscode/                   # ← コピー元
├── .cursor/                   # ← コピー元
└── package.json
```

#### C. セットアップ処理（すべて自動実行）
- [x] 1. **.vscode/ディレクトリコピー**: VSCode設定の継承
- [x] 2. **.cursor/ディレクトリコピー**: Cursor設定の継承
- [x] 3. **.npmrcファイルコピー**: NPMトークン設定の継承
- [x] 4. **Prismaコード生成**: `npx prisma generate`で型定義生成
- [x] 5. **pnpm install無効化**: パフォーマンス向上のため削除
- [x] 6. **シェルスクリプト実行**: セットアップをターミナルで実行して進捗表示

#### D. iTerm2タブ起動（修正済み）
- [x] **新しいタブ**: パフォーマンスと安定性重視でタブ利用
- [x] **`open -a iTerm.app .`**: シンプルで確実な起動方法
- [x] **自動ディレクトリ移動**: worktreeディレクトリで確実に起動

### ⚠️ エラーハンドリング要件

#### 必須チェック項目
- [x] 1. **ブランチ名空チェック**: 空文字入力時はエラー
- [x] 2. **重複worktreeチェック**: 既存ディレクトリがある場合はエラー
- [x] 3. **Git操作失敗**: worktree作成失敗時の適切なメッセージ
- [x] 4. **ディレクトリ作成権限**: `.worktrees/`作成権限チェック

#### エラーメッセージ例
- [x] `"ブランチ名が必要です"`
- [x] `"Worktreeが既に存在します: .worktrees/feature-login"`
- [x] `"Git worktree作成に失敗しました: [エラー詳細]"`

### 🎯 成功条件
- [x] **処理速度**: 10秒以内でセットアップ完了（pnpm install無効化により達成）
- [x] **安定性**: エラーでNeovimがクラッシュしない、バックグラウンド処理でUI応答性維持
- [x] **ユーザビリティ**: 1回の操作で完全なworktree環境が立ち上がる
- [x] **iTerm2連携**: タブで確実にworktreeディレクトリを開く

### ⚡ パフォーマンス最適化要件

#### pnpm install の最適化（実装済み）
- [x] **無効化**: パフォーマンス向上のためpnpm installを削除
- [x] **必要時のみ実行**: コメントアウトされ、必要に応じて有効化可能
- [x] **代替処理**: Prisma生成など必要最小限の処理のみ実行

#### ファイル操作の最適化
- [x] **コピー処理**: .vscode/.cursor/.npmrcの存在チェックしてからコピー
- [x] **シェルスクリプト実行**: ターミナルで実行して進捗を可視化
- [x] **一時ファイル管理**: スクリプト実行後60秒で自動削除

#### UI応答性と削除処理最適化
- [x] **即座のフィードバック**: キー押下後すぐに"処理開始"通知
- [x] **進捗更新**: 各ステップ完了時に状況報告
- [x] **完了通知**: "✅ Worktree完了: [ブランチ名]"
- [x] **バックグラウンド削除**: `vim.system`による非同期削除処理
- [x] **自動モード切り替え**: 入力・確認時の自動インサート/ノーマルモード

### 🔧 リファクタリング意識

#### コードの保守性
- [ ] **関数分割**: 各処理を独立した関数に分離
- [ ] **エラーハンドリング統一**: 一貫したエラー処理パターン
- [ ] **設定の外部化**: パス設定などを変数で管理

#### 拡張性の確保
- [ ] **プラグイン構造**: 他の機能追加時に影響しない設計
- [ ] **設定可能性**: ディレクトリ名やコマンドのカスタマイズ対応
- [ ] **テスタビリティ**: 各機能の単体テストが可能な構造

### 📍 追加実装された機能（元は対象外だったが完成）

#### 🔄 Worktree切り替え機能 (`<leader>gw`)
- [x] **Telescope UI**: worktreeリストをTelescope形式で表示
- [x] **現在位置表示**: "👈 current"マークで現在のworktreeを明示
- [x] **ディレクトリ切り替え**: 選択したworktreeにcd移動
- [x] **Neo-tree連携**: 切り替え後にNeo-treeを自動更新
- [x] **メインプロジェクト対応**: メインプロジェクトも選択肢に含める

#### 🗑️ Worktree削除機能 (`<leader>gw` → `Ctrl+D`)
- [x] **安全性**: main/masterブランチは削除不可
- [x] **確認UI**: 削除前に確認プロンプト表示
- [x] **3段階削除**: prune → force remove → ディレクトリ削除
- [x] **非同期処理**: `vim.system`によるバックグラウンド削除
- [x] **修復機能**: 壊れたworktreeの自動修復削除

## ✅ 実装タスク

### Phase 1: Worktree作成機能 - **完了！** 🎉
- [x] 1. プラグイン基本構造を作成 (git-worktree.luaを初期化済み)
- [x] 2. ブランチ名入力UI実装（自動モード切り替え付き）
- [x] 3. Git worktree作成コマンド実装
- [x] 4. ディレクトリ作成 (git-worktrees/ブランチ名)
- [x] 5. エラーハンドリング追加
- [x] 6. .vscode/.cursor/.npmrcコピー機能  
- [x] 7. Prismaコード生成機能
- [x] 8. iTerm2新タブでディレクトリ起動
- [x] 9. 動作テスト・デバッグ
- [x] 10. 最終確認 - **test/7で成功確認済み**

### Phase 2: 拡張機能 - **完了！** 🎉
- [x] Worktree一覧・切り替え機能 (Telescope UI)
- [x] 削除機能 (バックグラウンド処理、修復対応)
- [x] 現在worktree表示機能
- [x] 自動モード切り替え機能

## 📋 技術要件 - **完全達成！**
- **ファイル**: `/Users/ren/.config/nvim/lua/plugins/git-worktree.lua` (414行)
- **キーバインド**: 
  - `<leader>gW` - Worktree作成
  - `<leader>gw` - Worktree一覧・切り替え・削除
  - `<Ctrl+D>` - 削除モード（worktreeリスト内）
- **処理時間**: 10秒以内完了（pnpm install無効化により達成）
- **依存関係**: 
  - `plenary.nvim` - 基盤プラグイン
  - `telescope.nvim` - UI表示
  - `vim.system` - 非同期処理

## 🎯 完成度
### ✅ 完全実装済み機能
1. **Worktree作成機能** - 完璧動作
2. **Worktree切り替え機能** - 完璧動作  
3. **Worktree削除機能** - 完璧動作（バックグラウンド処理）
4. **自動モード切り替え** - 完璧動作
5. **エラーハンドリング** - 完璧動作
6. **iTerm2連携** - 完璧動作

### 🔧 最適化の余地（リファクタリング対象）
- **コード行数**: 414行 → 200行程度に短縮可能
- **デバッグコード除去**: デバッグ用のnotifyメッセージが多数
- **関数分割**: 大きな関数を小さな機能単位に分割
- **設定の外部化**: パス設定などを変数で管理